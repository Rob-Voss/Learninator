<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: entities/Agent.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: entities/Agent.js</h1>






    <section>
        <article>
            <pre class="prettyprint source linenums"><code>var Agent = Agent || {},
    Eye = Eye || {},
    Entity = Entity || {},
    Utility = Utility || {};

(function (global) {
    "use strict";

    /**
     * Options for the Agent
     * @typedef {Object} agentOpts
     * @property {boolean} worker - Is the Agent a Web Worker
     * @property {string} brainType - The type of Brain to use
     * @property {number} numTypes - The number of types the Agent can sense
     * @property {number} numEyes - The number of the Agent's eyes
     * @property {number} range - The range of the eyes
     * @property {number} proximity - The proximity range of the eyes
     * @property {cheatOpts} cheats - The cheats to display
     * @property {brainOpts} spec - The brain options
     * @property {Object} env - The environment
     */

    /**
     * The options for the Agents brain
     * @typedef {Object} brainOpts
     * @property {string} update - qlearn | sarsa
     * @property {number} gamma - Discount factor [0, 1]
     * @property {number} epsilon - Initial epsilon for epsilon-greedy policy [0, 1]
     * @property {number} alpha - Value function learning rate
     * @property {number} experienceAddEvery - Number of time steps before we add another experience to replay memory
     * @property {number} experienceSize - Size of experience
     * @property {number} learningStepsPerIteration - Number of steps to go through during one tick
     * @property {number} tdErrorClamp - For robustness
     * @property {number} numHiddenUnits - Number of neurons in hidden layer
     */

    /**
     * Initialize the Agent
     * @name Agent
     * @extends Entity
     * @constructor
     *
     * @param {Vec} position - The x, y location
     * @param {agentOpts} opts - The Agent options
     * @returns {Agent}
     */
    function Agent(position, opts) {
        // Is it a worker
        this.worker = Utility.getOpt(opts, 'worker', false);
        Entity.call(this, (this.worker) ? 'Agent Worker' : 'Agent', position, opts);
        // Just a text value for the brain type, also useful for worker posts
        this.brainType = Utility.getOpt(opts, 'brainType', 'TD');
        // The number of item types the Agent's eyes can see
        this.numTypes = Utility.getOpt(opts, 'numTypes', 3);
        // The number of Agent's eyes
        this.numEyes = Utility.getOpt(opts, 'numEyes',  9);
        // The range of the Agent's eyes
        this.range = Utility.getOpt(opts, 'range',  85);
        // The proximity of the Agent's eyes
        this.proximity = Utility.getOpt(opts, 'proximity',  85);
        // The number of Agent's eyes times the number of known types
        this.numStates = this.numEyes * this.numTypes;

        // Set the brain options
        this.brainOpts = Utility.getOpt(opts, 'spec', {
            update: "qlearn", // qlearn | sarsa
            gamma: 0.9, // discount factor, [0, 1)
            epsilon: 0.2, // initial epsilon for epsilon-greedy policy, [0, 1)
            alpha: 0.005, // value function learning rate
            experienceAddEvery: 5, // number of time steps before we add another experience to replay memory
            experienceSize: 10000, // size of experience
            learningStepsPerIteration: 5,
            tdErrorClamp: 1.0, // for robustness
            numHiddenUnits: 100 // number of neurons in hidden layer
        });

        // The Agent's environment
        this.env = Utility.getOpt(opts, 'env',  {
            numActions: this.numActions,
            numStates: this.numStates,
            getMaxNumActions: function () {
                return this.numActions;
            },
            getNumStates: function () {
                return this.numStates;
            }
        });

        // The Agent's eyes
        if (this.eyes === undefined) {
            this.eyes = [];
            for (let k = 0; k &lt; this.numEyes; k++) {
                this.eyes.push(new Eye(k * 0.21, this.pos, this.range, this.proximity));
            }
        }

        this.action = null;
        this.avgReward = 0;
        this.lastReward = 0;
        this.digestionSignal = 0.0;
        this.rewardBonus = 0.0;
        this.previousActionIdx = -1;
        this.epsilon = 0.000;

        this.pts = [];
        this.direction = 'N';
        this.brain = {};
        this.brainState = {};
        this.world = {};

        return this;
    }

    Agent.prototype = Object.create(Entity.prototype);
    Agent.prototype.constructor = Entity;

    /**
     * Agent's chance to learn
     * @returns {Agent}
     */
    Agent.prototype.learn = function () {
        this.lastReward = this.digestionSignal;
        this.pts.push(this.digestionSignal);

        if (!this.worker) {
            this.brain.learn(this.digestionSignal);
            this.epsilon = this.brain.epsilon;
        } else {
            this.post('learn', this.digestionSignal);
        }

        return this;
    };

    /**
     * Load a pre-trained agent
     * @param {String} file
     */
    Agent.prototype.load = function (file) {
        let _this = this;
        $.getJSON(file, function(data) {
            if (!_this.worker) {
                _this.brain.fromJSON(data);
                _this.brain.epsilon = 0.05;
                _this.brain.alpha = 0;
            } else {
                _this.post('load', JSON.stringify(data));
            }
        });

        return this;
    };

    /**
     *
     */
    Agent.prototype.save = function () {
        if (!this.worker) {
            this.brainState = JSON.stringify(this.brain.toJSON());
        } else {
            this.post('save');
        }
    };

    /**
     * Tick the agent
     * @param {Object} world
     */
    Agent.prototype.tick = function (world) {
        this.world = world;
        // Let the agents behave in the world based on their input
        this.act();

        // If it's not a worker we need to run the rest of the steps
        if (!this.worker) {
            // Move eet!
            this.move();
            // This is where the agents learns based on the feedback of their
            // actions on the environment
            this.learn();
        }

        return this;
    };

    /**
     * Eye sensor has a maximum range and senses entities and walls
     * @param angle
     * @param range
     * @param proximity
     * @returns {Eye}
     * @name Eye
     * @constructor
     */
    function Eye(angle, position, range, proximity) {
        this.angle = angle;
        this.maxRange = range || 85;
        this.sensedProximity = proximity || 85;
        this.pos = position || new Vec(0, 0);
        this.maxPos = new Vec(0, 0);
        this.sensedType = -1;
        this.collisions = [];

        // PIXI graphics
        this.shape = new PIXI.Graphics();

        return this;
    }

    /**
     * Draw the lines for the eyes
     * @param agent
     */
    Eye.prototype.draw = function (agent) {
        this.pos = agent.pos.clone();
        this.shape.clear();

        switch (this.sensedType) {
            case -1:
            case 0:
                // Is it wall or nothing?
                this.shape.lineStyle(0.5, 0x000000);
                break;
            case 1:
                // It is noms
                this.shape.lineStyle(0.5, 0xFF0000);
                break;
            case 2:
                // It is gnar gnar
                this.shape.lineStyle(0.5, 0x00FF00);
                break;
            case 3:
            case 4:
            case 5:
                // Is it another Agent
                this.shape.lineStyle(0.5, 0xFAFAFA);
                break;
            default:
                this.shape.lineStyle(0.5, 0x000000);
                break;
        }

        let aEyeX = this.pos.x + this.sensedProximity * Math.sin(agent.angle + this.angle),
            aEyeY = this.pos.y + this.sensedProximity * Math.cos(agent.angle + this.angle);
        this.maxPos.set(aEyeX, aEyeY);

        // Draw the agent's line of sights
        this.shape.moveTo(this.pos.x, this.pos.y);
        this.shape.lineTo(aEyeX, aEyeY);
    };

    /**
     * Sense the surroundings
     * @param agent
     */
    Eye.prototype.sense = function (agent) {
        this.pos = agent.pos.clone();
        let result,
            aEyeX = this.pos.x + this.maxRange * Math.sin(agent.angle + this.angle),
            aEyeY = this.pos.y + this.maxRange * Math.cos(agent.angle + this.angle);
        this.maxPos.set(aEyeX, aEyeY);
        result = agent.world.sightCheck(this.pos, this.maxPos, agent.world.walls, agent.world.agents.concat(agent.world.entities), agent.radius);
        if (result) {
            // eye collided with an entity
            this.sensedProximity = result.vecI.distFrom(this.pos);
            this.sensedType = result.target.type;
            if ('vx' in result.vecI) {
                this.x = result.vecI.x;
                this.y = result.vecI.y;
                this.vx = result.vecI.vx;
                this.vy = result.vecI.vy;
            } else {
                this.x = 0;
                this.y = 0;
                this.vx = 0;
                this.vy = 0;
            }
        } else {
            this.sensedProximity = this.maxRange;
            this.sensedType = -1;
            this.x = 0;
            this.y = 0;
            this.vx = 0;
            this.vy = 0;
        }
    };

    global.Eye = Eye;
    global.Agent = Agent;

}(this));

</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Agent.html">Agent</a></li><li><a href="AgentGA.html">AgentGA</a></li><li><a href="AgentRLDQN.html">AgentRLDQN</a></li><li><a href="AgentRLTD.html">AgentRLTD</a></li><li><a href="AgentTD.html">AgentTD</a></li><li><a href="Bitmap.html">Bitmap</a></li><li><a href="BruteCD.html">BruteCD</a></li><li><a href="Button.html">Button</a></li><li><a href="Camera.html">Camera</a></li><li><a href="Cell.html">Cell</a></li><li><a href="Chromosome.html">Chromosome</a></li><li><a href="CollisionDetector.html">CollisionDetector</a></li><li><a href="Cube.html">Cube</a></li><li><a href="datGUI.html">datGUI</a></li><li><a href="DeterministPG.html">DeterministPG</a></li><li><a href="Display.html">Display</a></li><li><a href="DPAgent.html">DPAgent</a></li><li><a href="DQNAgent.html">DQNAgent</a></li><li><a href="Entity.html">Entity</a></li><li><a href="EntityRLDQN.html">EntityRLDQN</a></li><li><a href="ESPNet.html">ESPNet</a></li><li><a href="ESPTrainer.html">ESPTrainer</a></li><li><a href="Eye.html">Eye</a></li><li><a href="GATrainer.html">GATrainer</a></li><li><a href="Graph.html">Graph</a></li><li><a href="Grid.html">Grid</a></li><li><a href="GridCD.html">GridCD</a></li><li><a href="GridWorld.html">GridWorld</a></li><li><a href="Hex.html">Hex</a></li><li><a href="HexGrid.html">HexGrid</a></li><li><a href="HexWorld.html">HexWorld</a></li><li><a href="Interactions.html">Interactions</a></li><li><a href="Map.html">Map</a></li><li><a href="Mat.html">Mat</a></li><li><a href="Maze.html">Maze</a></li><li><a href="MazeWorld.html">MazeWorld</a></li><li><a href="Menu.html">Menu</a></li><li><a href="Player.html">Player</a></li><li><a href="Point.html">Point</a></li><li><a href="PuckWorld.html">PuckWorld</a></li><li><a href="QuadCD.html">QuadCD</a></li><li><a href="QuadTree.html">QuadTree</a></li><li><a href="RecurrentReinforceAgent.html">RecurrentReinforceAgent</a></li><li><a href="RewardGraph.html">RewardGraph</a></li><li><a href="SimpleReinforceAgent.html">SimpleReinforceAgent</a></li><li><a href="Solver.html">Solver</a></li><li><a href="TDAgent.html">TDAgent</a></li><li><a href="Vec.html">Vec</a></li><li><a href="Wall.html">Wall</a></li><li><a href="WaterWorld.html">WaterWorld</a></li><li><a href="WaterWorldEX.html">WaterWorldEX</a></li><li><a href="WaterWorldGA.html">WaterWorldGA</a></li><li><a href="Window.html">Window</a></li><li><a href="World.html">World</a></li><li><a href="%257Bobject%257D%2520input.html">{object} input</a></li></ul><h3>Global</h3><ul><li><a href="global.html#clear">clear</a></li><li><a href="global.html#clone">clone</a></li><li><a href="global.html#divide">divide</a></li><li><a href="global.html#EZGUI">EZGUI</a></li><li><a href="global.html#findByAngle">findByAngle</a></li><li><a href="global.html#findByName">findByName</a></li><li><a href="global.html#findInsertNode">findInsertNode</a></li><li><a href="global.html#findOverlappingNodes">findOverlappingNodes</a></li><li><a href="global.html#initSensors">initSensors</a></li><li><a href="global.html#insert">insert</a></li><li><a href="global.html#isAndroid">isAndroid</a></li><li><a href="global.html#isChrome">isChrome</a></li><li><a href="global.html#isFirefox">isFirefox</a></li><li><a href="global.html#isGecko">isGecko</a></li><li><a href="global.html#isIE">isIE</a></li><li><a href="global.html#isIOS">isIOS</a></li><li><a href="global.html#isIPad">isIPad</a></li><li><a href="global.html#isIPhone">isIPhone</a></li><li><a href="global.html#isIPod">isIPod</a></li><li><a href="global.html#isKindle">isKindle</a></li><li><a href="global.html#isMobile">isMobile</a></li><li><a href="global.html#isOpera">isOpera</a></li><li><a href="global.html#isSafari">isSafari</a></li><li><a href="global.html#isTablet">isTablet</a></li><li><a href="global.html#isTV">isTV</a></li><li><a href="global.html#isWebKit">isWebKit</a></li><li><a href="global.html#resetSensors">resetSensors</a></li><li><a href="global.html#retrieve">retrieve</a></li><li><a href="global.html#Utility">Utility</a></li><li><a href="global.html#whoami">whoami</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.3</a> on Mon Dec 07 2015 11:58:41 GMT-0800 (PST)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
